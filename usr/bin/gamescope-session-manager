#!/bin/bash

# Exit immediately on error and throw an error
# when using undefined variables
set -eu

STEAM_LOCAL_USERNAME="steam"

# Print usage
function usage() {
    printf "Usage: %s [options] [cinnamon|gnome|gnome-classic|hyprland|plasma-wayland|ubuntu]\n\n" "$0"
    printf "Options:\n"
    printf "   -h | --help   Show this help message\n"
    printf "   -l | --loop   Loop back to SteamOS mode\n"
    printf "   -s | --skip-local-username-check   Skip %s local user account check\n" "$STEAM_LOCAL_USERNAME"
}

# Check for command line arguments.
function check_args() {
    for arg in "$@"; do
        case $arg in
            # Check if help is requested then exit
            -h|--help)
            usage
            exit
            ;;
            # If loop option is specified enable continuous loop
            -l|--loop)
            enable_loop
            shift
            ;;
            # If skip-local-username-check option is specified set enable skip
            -s|--skip-local-username-check)
            disable_check_local_username
            shift
            ;;
            # Set the desktop to launch from the available options
            cinnamon|gnome|gnome-classic|hyprland|plasma-wayland|ubuntu)
            set_desktop "$arg"
            shift
            ;;
            *)
            printf "%s: invalid argument: %s\n" "$0" "$arg"
            printf "See --help for a list of arguments.\n"
            exit
            ;;
        esac
    done
}

CHECK_LOCAL_USERNAME_FLAG=true

function disable_check_local_username() {
    CHECK_LOCAL_USERNAME_FLAG=false
}

# Assume that dependencies are not installed
LOCATE_CMD=""
STEAM_CMD=""
GAMESCOPE_CMD=""
MANGOAPP_CMD=""

# Assume that MangoHud is not installed.
MANGOAPP_FLAG=""


function check_dependencies() {
    # Check if the local account is set up on the system, otherwise exit (or skip if not required)
    if "$CHECK_LOCAL_USERNAME_FLAG"
    then
        getent passwd "$STEAM_LOCAL_USERNAME" > /dev/null 2>&1 || {
            printf >&2 "[%s] [Error] A separate '%s' Linux user account is required on this system.\n" "$0" "$STEAM_LOCAL_USERNAME"
            exit
        }
    fi

    # Identify paths of each dependency
    LOCATE_CMD="$(command -v locate)"
    STEAM_CMD="$(command -v steam)"
    GAMESCOPE_CMD="$(command -v gamescope)"
    MANGOAPP_CMD="$(command -v mangoapp)"

    # Check if `locate` dependency is available, otherwise halt
    if [[ -z "$LOCATE_CMD" ]]
    then
        printf "[%s] [Error] 'locate' is not installed. Please install it before proceeding.\n" "$0"
        exit
    fi

    # Check if `steam` dependency is available, otherwise halt
    if [[ -z "$STEAM_CMD" ]]
    then
        printf "[%s] [Error] 'steam' is not installed. Please install it before proceeding.\n" "$0"
        exit
    fi

    # Check if `gamescope` dependency is available, otherwise halt
    if [[ -z "$GAMESCOPE_CMD" ]]
    then
        printf "[%s] [Error] 'gamescope' is not installed. Please install it before proceeding.\n" "$0"
        exit
    fi

    # For MangoApp, if it exists then set the MANGOAPP_FLAG
    if [[ -z "$MANGOAPP_CMD" ]]
    then
        printf "[%s] [Info] 'mangoapp' is not available on your system. Check to see that MangoHud is installed.\n" "$0"
        printf "[%s] [Info] Continuing without the '--mangoapp' flag.\n" "$0"
    else
        MANGOAPP_FLAG="--mangoapp" 
    fi

    printf "[%s] [Info] All dependencies are installed.\n" "$0"
}

# Assume the loop will only run once.
RUN_ONCE=true

# Enable continuous loop
function enable_loop() {
    RUN_ONCE=false
}

# Assume no desktop environment specified
DESKTOP=""

# Set the desktop to launch
function set_desktop() {
    DESKTOP="$1"
}

# Launch the desktop based on the desktop environment set
function launch_desktop() {
    # More desktop environment options can be added here and include in the check_args() function
    case "$DESKTOP" in
        cinnamon) [[ -n "$(command -v cinnamon-session)" ]] && "$(command -v cinnamon-session)" || printf "[%s] [Info] Cinnamon not installed.\n" "$0" ;;
        gnome) [[ -n "$(command -v gnome-session)" ]] && "$(command -v gnome-session)" || printf "[%s] [Info] Gnome not installed.\n" "$0" ;;
        gnome-classic) [[ -n "$(command -v gnome-session)" ]] && env GNOME_SHELL_SESSION_MODE=classic "$(command -v gnome-session)" || printf "[%s] [Info] Gnome not installed.\n" "$0" ;;
        hyprland) [[ -n "$(command -v Hyprland)" ]] && "$(command -v Hyprland)" || printf "[%s] [Info] Hyprland not installed.\n" "$0" ;;
        plasma-wayland) [[ -n "$(command -v startplasma-wayland)" ]] && "$(locate plasma-dbus-run-session-if-needed)" "$(command -v startplasma-wayland)" || printf "[%s] [Info] Plasma Wayland not installed.\n" "$0" ;;
        ubuntu) [[ -n "$(command -v gnome-session)" ]] && env GNOME_SHELL_SESSION_MODE=ubuntu "$(command -v gnome-session)" --session=ubuntu || printf "[%s] [Info] Ubuntu desktop not available.\n" "$0" ;;
        *) printf "[%s] [Info] Unknown session.\n" "$0"; exit;
    esac
}

# Launch Steam in SteamOS mode
function launch_steam() {
    "$GAMESCOPE_CMD" \
        "$MANGOAPP_FLAG" \
        -e -- "$STEAM_CMD" -steamdeck -steamos3
}


# First check the arguments.
check_args "$@"

# Then check for dependencies.
check_dependencies

# Now run loop.
while true; do
    # Launch Steam
    launch_steam

    # If the desktop environment is specified, launch the desktop.
    if [[ -n "$DESKTOP" ]]
    then
        launch_desktop
    fi

    # If this loop is to only run once, then break loop.
    if "$RUN_ONCE"
    then
        break
    fi
done